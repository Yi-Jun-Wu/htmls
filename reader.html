<!DOCTYPE html>
<html lang="zh">
  <head encoding="UTF-8">
    <title>阅读器</title>
    <style>
      body {
        font-size: 26px;
      }
      #file-content.drop-area {
        min-height: 80vh;
        border: 2px dashed #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #aaa;
        font-size: 18px;
        cursor: pointer;
      }
      #file-content {
        margin: auto;
        margin-top: 20px;
        padding: 30px;
        border: 1px solid #ccc;
        border-radius: 5px;
        /* background-color: #f9f9f9;
        color: #1b1b1b; */
        max-width: 90vw;
        /* font-size: 2em; */
        font-size: 1em;
        text-indent: 2em;
      }
      #file-content > p {
        min-height: 0.6em;
        margin-block-start: 0.2em;
        margin-block-end: 0.2em;
      }
      #file-input2 {
        display: none;
      }
      #file-input {
        /* margin-left: 50px; */
        margin: 50px;
        font-size: 2em;
        display: none;
      }
      #control {
        display: none;
        justify-content: center;
        margin-top: 50px;
        /* margin-bottom: 50px; */
        column-gap: 30px;
      }
      button {
        min-width: 3em;
        font-size: 1em;
        /* border-radius: 20px; */
      }
      a {
        color: -webkit-link;
        cursor: pointer;
        text-decoration: underline;
      }
      #info {
        /* font-size: 2em; */
        /* display: flex; */
        display: none;
        justify-content: center;
        margin-top: 50px;
        column-gap: 30px;
        flex-direction: column;
        align-content: center;
        align-items: center;
        margin-bottom: 50px;
        row-gap: 10px;
      }
      #info button {
        font-size: 1em;
        min-width: 5vw;
        margin: 0 10px;
      }
      .color-selector {
        display: inline-flex;
        flex-wrap: wrap;
        flex-direction: row;
        justify-content: flex-start;
        row-gap: 5px;
        column-gap: 10px;
      }
      .color-ball {
        min-width: 1em !important;
        width: 1em !important;
        height: 1em !important;
        border-radius: 1em !important;
        margin: 5px;
        border: 1px solid #000 !important;
      }
      .color-ball:hover, .color-ball.selected {
        transform: scale(1.3);
        box-shadow: #aaa 0 0 5px;
      }
      #loading_file {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-evenly;
        align-items: center;
        align-content: center;
        row-gap: 10px;
      }
      #select-list {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 100;
        /* display: flex; */
        justify-content: center;
        align-items: center;
        /* padding-left: 10px; */
      }
      #file-list {
        background-color: #f9f9f9;
        padding: 20px;
        padding-left: 30px;
        margin: auto;
        /* margin-left: ; */
        border-radius: 10px;
        max-width: calc(80vw - 40px);
        max-height: 80vh;
        overflow: auto;
      }
      #file-list li {
        margin: 10px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        cursor: pointer;
      }
      #javascript-disabled {
        /* display: block; */
        text-align: center;
        color: red;
        font-size: 2em;
      }

      /* 悬浮菜单样式 */
      .context-menu {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        padding: 5px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
        opacity: 0.8;
        user-select: none;
      }

      .context-menu div {
        padding: 5px 10px;
        cursor: pointer;
      }

      .context-menu div:hover {
        background: #f0f0f0;
      }

      .highlight {
        background-color: yellow;
      }
      .highlight:hover {
        text-decoration: underline orange;
      }
      .notes {
        background-color: greenyellow;
      }
      .notes:hover {
        text-decoration: underline green;
      }
    </style>
  </head>
  <body>
    <h2 id="javascript-disabled">
      警告: 请启用 Javascript 功能 <br> Warn: Please enable Javascript in
      browser.
    </h2>
    <input type="file" id="file-input" />
    <input type="file" id="file-input2" />
    <div id="file-content" class="drop-area">Drag & Drop a file here</div>
    <div id="control">
      <button id="prevChapter">上一章</button>
      <button id="showChapter">目录</button>
      <button id="nextChapter">下一章</button>
    </div>
    <div class="info" id="info">
      <div>阅读时间: <span id="reading-time">0</span> min</div>
      <div>阅读进度: <span id="reading-progress">0</span> %</div>
      <div>
        设置字体: <span style="display: inline-block"><button id="font-smaller">
            缩小
          </button>
          <span id="global-font-size">26</span> px <button id="font-larger">
            放大
          </button></span>
      </div>
      <div>
        设置文本颜色: <span
          class="color-selector"
          id="selector-color"
          target="color"
        ></span>
      </div>
      <div>
        设置背景色: <span
          class="color-selector"
          id="selector-background-color"
          target="background-color"
        ></span>
      </div>
    </div>
    <p id="loading_file">
      <button id="load_from_fs">读取本地文本文件</button>
      <button id="load_from_opfs">加载缓存文本文件</button>
      <button id="save_db_to_file">导出高亮标记数据</button>
      <button id="load_db_from_file">导入高亮标记文件</button>
    </p>
    <div id="select-list">
      <ul id="file-list"></ul>
    </div>
    <div id="contextMenu" class="context-menu">
      <div id="highlightText">标记</div>
      <div id="copyText">复制</div>
      <div id="commentText">注释</div>
    </div>
    <script>
      document.getElementById("javascript-disabled").style.display =
        "none";
      const state = {
        file_name: null,
        chapter: null,
        contents: [],
        titles: [],
        reading_time: null,
        last_time: null,

        highlights: [],

        font_size: 26,
        "background-color": "#f9f9f9",
        "color": "#1b1b1b",
      };
      const [
        fileInput,
        fileContent,
        dropArea,
        control,
        prevChapter,
        showChapter,
        nextChapter,
        infoDiv,
        readingTime,
        readingProgress,
        fontSmaller,
        globalFontSize,
        fontLarger,
        loadFromFs,
        loadFromOpfs,
        selectList,
        fileList,
        saveDbToFile,
        loadDbFromFile,
        fileInput2,
      ] = [
        "file-input",
        "file-content",
        "file-content",
        "control",
        "prevChapter",
        "showChapter",
        "nextChapter",
        "info",
        "reading-time",
        "reading-progress",
        "font-smaller",
        "global-font-size",
        "font-larger",
        "load_from_fs",
        "load_from_opfs",
        "select-list",
        "file-list",
        "save_db_to_file",
        "load_db_from_file",
        "file-input2",
      ].map((id) => document.getElementById(id));

      // mobile adaptation
      function isMobile() {
        // return /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        // document.write(`<h1>agent:${navigator.userAgent||navigator.vendor||window.opera}</h1>`);
        let check = false;
        (function (a) {
          if (
            /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i
              .test(a) ||
            /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i
              .test(a.substr(0, 4))
          ) check = true;
        })(navigator.userAgent || navigator.vendor || window.opera);
        return check;
      }
      if (isMobile()) {
        // document.write("<h1>请使用手机打开</h1>");
        fileInput.style.display = "block";
      }

      // Initialize the drag & drop listeners
      dropArea.addEventListener("dragover", (event) => {
        event.preventDefault();
        dropArea.style.borderColor = "green"; // Optional: Change border color on drag over
      });
      dropArea.addEventListener("dragleave", () => {
        dropArea.style.borderColor = "#ccc"; // Reset border color
      });
      dropArea.addEventListener("drop", (event) => {
        event.preventDefault();
        dropArea.style.borderColor = "#ccc"; // Reset border color after drop
        const files = event.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          readFile(file);
        }
      });
      dropArea.addEventListener("click", () => {
        if (!state.file_name) {
          fileInput.click();
        }
      });
      loadFromFs.addEventListener("click", () => {
        fileInput.click();
      });
      fileInput.addEventListener(
        "change",
        (event) => readFile(event.target.files[0]),
      );
      document.addEventListener("keydown", (event) => {
        // console.log(event.key);
        if (!state.file_name) {
          return;
        }
        if (event.key === "ArrowRight") {
          readChapter(state.chapter + 1);
        } else if (event.key === "ArrowLeft") {
          readChapter(state.chapter - 1);
        }
      });
      document.addEventListener("scroll", updateTime);
      prevChapter.addEventListener(
        "click",
        () => prevChapter.blur(readChapter(state.chapter - 1)),
      );
      showChapter.addEventListener(
        "click",
        () => showChapter.blur(showChapterList()),
      );
      nextChapter.addEventListener(
        "click",
        () => nextChapter.blur(readChapter(state.chapter + 1)),
      );

      function renderContent(container, text, highlights) {
        function split_lines_and_ranges(text, highlights) {
          const lines = text.split("\n");
          const lineData = lines.map((line) => ({
            text: line,
            notes: [],
          }));

          highlights.forEach(({ pos, extends: ext }, index) => {
            let [startLine, startChar] = pos;
            let [extendLines, extendChars] = ext;
            let endLine = startLine + extendLines;
            let endChar = (extendLines === 0)
              ? startChar + extendChars
              : extendChars;

            for (let i = startLine; i <= endLine; i++) {
              let rangeStart = i === startLine ? startChar : 0;
              let rangeEnd = i === endLine
                ? endChar
                : lineData[i].text.length;

              lineData[i].notes.push([rangeStart, rangeEnd, index]);
            }
          });

          return lineData;
        }

        function get_line_with_notes(lineData, highlights) {
          let { text, notes } = lineData;
          if (notes.length === 0) return escapeHtml(text);

          // 1. 处理交叠范围，按 start 位置升序排列，若相等则按 end 位置降序排列
          notes.sort((
            a,
            b,
          ) => (a[0] === b[0] ? b[1] - a[1] : a[0] - b[0]));
          const resolvedRanges = [];
          notes.forEach((newRanges) => {
            resolvedRanges.forEach((prev) => {
              if (
                newRanges[0] > prev[0] && newRanges[0] < prev[1] &&
                newRanges[1] > prev[1]
              ) {
                newRanges[0] = prev[1];
              }
            });
            resolvedRanges.push(newRanges);
          });
          // 2. 生成 HTML 代码
          resolvedRanges.sort((
            a,
            b,
          ) => (a[0] === b[0] ? b[1] - a[1] : a[0] - b[0]));
          // console.log(resolvedRanges);
          const spans = [];
          for (let i = 0; i < resolvedRanges.length; i++) {
            const [start, end, index] = resolvedRanges[i];
            spans.push([start, i, index]);
            spans.push([end, -1, index]);
          }
          spans.sort((a, b) =>
            a[0] === b[0] ? a[1] - b[1] : a[0] - b[0]
          );
          // console.log(spans);

          let result = "";
          let lastIndex = 0;
          for (const [pos, start, index] of spans) {
            result += escapeHtml(text.slice(lastIndex, pos));
            lastIndex = pos;
            if (start === -1) {
              result += "</span>";
            } else {
              result += `<span class="${
                highlights[index].type
              } notes-${index}">`;
            }
          }
          if (lastIndex < text.length) {
            result += escapeHtml(text.slice(lastIndex));
          }
          return result;
        }

        function escapeHtml(str) {
          return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function init_tooltips(highlights) {
          function set_selected_dec(index, textDecoration = "none") {
            document.querySelectorAll(`.notes-${index}`).forEach(
              (span) => {
                span.style.textDecoration = textDecoration;
                // console.log(span, textDecoration);
              },
            );
          }

          highlights.forEach(({ notes, time, type }, index) => {
            document.querySelectorAll(`.notes-${index}`).forEach(
              (span) => {
                span.addEventListener("mouseenter", function (event) {
                  set_selected_dec(
                    index,
                    "underline solid " +
                      (type === "highlight" ? "orange" : "green"),
                  );
                  let tooltip = document.createElement("div");
                  tooltip.className = "tooltip";
                  if (type === "highlight") {
                    tooltip.innerText = `标记于: ${
                      new Date(time).toLocaleString()
                    }`;
                  } else {
                    tooltip.innerText = `${notes}\n注记于: ${
                      new Date(time).toLocaleString()
                    }`;
                  }
                  document.body.appendChild(tooltip);

                  let rect = this.getBoundingClientRect();
                  tooltip.style.position = "absolute";
                  tooltip.style.left = `${
                    rect.left + window.scrollX
                  }px`;
                  tooltip.style.top = `${
                    rect.bottom + window.scrollY
                  }px`;
                  tooltip.style.background = "rgba(0, 0, 0, 0.8)";
                  tooltip.style.color = "white";
                  tooltip.style.padding = "5px 10px";
                  tooltip.style.borderRadius = "5px";
                  tooltip.style.fontSize = "12px";
                  tooltip.style.whiteSpace = "nowrap";
                  tooltip.style.display = "block";
                  tooltip.style.zIndex = "1000";

                  this.addEventListener("mouseleave", () => {
                    set_selected_dec(index);
                    tooltip.remove();
                  }, { once: true });
                });
              },
            );
          });
        }

        // function (container, text, highlights) {
        const lineData = split_lines_and_ranges(text, highlights);
        // const container = document.getElementById("content");
        // container.innerHTML = "";

        lineData.forEach((line) => {
          let p = document.createElement("p");
          p.innerHTML = get_line_with_notes(line, highlights);
          container.appendChild(p);
        });

        init_tooltips(highlights);
        // };
      }

      function updateTime() {
        if (state.reading_time === null) {
          return;
        }
        if (state.last_time === null) {
          state.last_time = Date.now();
          return;
        }
        const now = Date.now();
        state.reading_time += Math.min(now - state.last_time, 90000);
        readingTime.innerText = Math.round(state.reading_time / 60000);
        readingProgress.innerText = Math.round(
          state.chapter / state.contents.length * 100,
        );
        state.last_time = now;
      }
      function set_format_as_opened() {
        infoDiv.style.display = "flex";
        fileInput.style.display = "none";
        control.style.display = "flex";
        fileContent.classList.remove("drop-area");
      }
      // read file from file input
      function readFile(file) {
        const reader = new FileReader();
        reader.onload = () => {
          // fileContent.innerText = reader.result.slice(0, 100);
          state.file_name = file.name;
          state.titles = [];
          state.contents = [];
          const lines = reader.result.split("\n");
          let title = file.name;
          let new_title = "";
          let content = "";
          let last_content = "";
          let length = 0;
          for (let i = 0; i < lines.length; i++) {
            const regex =
              /((^={3,}) +(.*?) +(\2))\r?$|(^第.{1,10}[卷章节](.*?))\r?$|^[ \t　]+(第.{1,10}[卷章节](.{0,20}))\r?$/;
            const m = lines[i].match(regex);
            // console.log(m, lines[i]);
            if (m) { // is a new title
              // put content to last_content
              last_content += content;
              content = "";
              // if the content is too short, this line is not a title
              if (length < 50) {
                content = lines[i].trim() + "\n";
                length = lines[i].length;
                new_title = m[3] || m[5] || m[7];
                continue;
              } else {
                // content is long enough, this line is a new title
                length = 0;
                state.titles.push(title);
                state.contents.push(last_content);
                title = m[3] || m[5] || m[7];
                last_content = "";
              }
            } else {
              content += lines[i].trim() + "\n";
              length += lines[i].length;
              // if content is long enough, this line is a title
              if (length > 80 && last_content !== "") {
                state.titles.push(title);
                state.contents.push(last_content);
                title = new_title;
                last_content = "";
              }
            }
          }
          state.titles.push(title);
          state.contents.push(content);
          state.reading_time = null;
          state.last_time = null;

          set_format_as_opened();
          readChapter(null);
          save_to_opfs(state.file_name, {
            file_name: state.file_name,
            titles: state.titles,
            contents: state.contents,
          });
        };
        reader.onerror = (e) => {
          infoDiv.style.display = "none";
          fileContent.classList.add("drop-area");
          control.style.display = "none";
          if (isMobile()) {
            fileInput.style.display = "block";
          }
          fileContent.innerText = e.target.error;
          state.file_name = null;
          state.chapter = null;
          state.reading_time = null;
          state.last_time = null;
        };
        reader.readAsText(file); // Read the file as text
      }
      async function readChapter(chapter) {
        if (chapter < 0) {
          chapter = 0;
        } else if (chapter >= state.contents.length) {
          chapter = state.contents.length - 1;
        }
        console.log(state.chapter, chapter);
        if (state.chapter !== chapter) {
          state.highlights = await getDatabase(
            state.file_name,
            chapter === null ? state.chapter : chapter,
          ) || [];
        }
        state.chapter = chapter;
        updateTime();
        updateStorage();
        document.title = state.titles[state.chapter] + " | " +
          state.file_name;
        fileContent.innerHTML = `<h2>${
          state.titles[state.chapter]
        }</h2>`;
        renderContent(
          fileContent,
          state.contents[state.chapter],
          state.highlights,
        );
        window.scrollTo(0, 0);
        fileContent.focus();
      }
      function showChapterList() {
        document.title = "目录 | " + state.file_name;
        fileContent.innerHTML = "<h2>目录</h2>" +
          state.titles
            .map((title, index) =>
              `<a onclick="readChapter(${index})">${title}</a>`
            )
            .join("<br>");
        window.scrollTo(0, 0);
        fileContent.focus();
        updateTime();
        // fileContent.innerText = state.titles.join("\n");
      }
      function updateStorage() {
        const cacheName = "txt_reader_cache";
        // get cache from local storage
        const cache = JSON.parse(localStorage.getItem(cacheName)) || {};
        cache.records = cache.records || {};
        const record = cache.records[state.file_name] =
          cache.records[state.file_name] || { time: 0, chapter: 0 };
        cache.reading = state.file_name;
        // load progress
        if (state.chapter === null) {
          state.chapter = record.chapter || 0;
        }
        if (state.reading_time === null) {
          state.reading_time = record.time || 0;
        }
        // save progress
        record.chapter = state.chapter;
        record.time = state.reading_time;
        localStorage.setItem(cacheName, JSON.stringify(cache));
      }

      function save_settings() {
        const cacheName = "txt_reader_settings";
        const setting = {
          font_size: state.font_size,
          "background-color": state["background-color"],
          "color": state["color"],
        };
        localStorage.setItem(cacheName, JSON.stringify(setting));
      }
      function load_settings() {
        const cacheName = "txt_reader_settings";
        const setting = JSON.parse(localStorage.getItem(cacheName)) ||
          {};
        if (setting.font_size) {
          state.font_size = setting.font_size;
          globalFontSize.innerText = state.font_size;
          document.body.style.fontSize = state.font_size + "px";
        }
        if (setting["background-color"]) {
          const color = setting["background-color"];
          state["background-color"] = color;
          document.body.style["background-color"] = color;
          const index = color_list.indexOf(color);
          document.getElementById("selector-background-color")
            .childNodes[index].classList.add("selected");
        }
        if (setting["color"]) {
          const color = setting["color"];
          state["color"] = color;
          document.body.style["color"] = color;
          const index = color_list.indexOf(color);
          document.getElementById("selector-color").childNodes[index]
            .classList.add("selected");
        }
      }
      // font size control
      function set_font_size(size) {
        const cacheName = "txt_reader_settings";
        state.font_size = size;
        globalFontSize.innerText = size;
        document.body.style.fontSize = size + "px";
        save_settings();
      }
      fontSmaller.addEventListener("click", () => {
        set_font_size(state.font_size - 2);
      });
      fontLarger.addEventListener("click", () => {
        set_font_size(state.font_size + 2);
        setTimeout(() => {
          window.scrollTo(0, document.documentElement.scrollHeight);
        });
      });
      // color control
      function set_color(target, color) {
        document.body.style[target] = color;
        state[target] = color;
        try {
          const nodes =
            document.getElementById("selector-" + target).childNodes;
          const index = color_list.indexOf(color);
          for (let i = 0; i < nodes.length; i++) {
            if (i === index) {
              // console.log(color, node.style.backgroundColor);
              nodes[i].classList.add("selected");
            } else {
              nodes[i].classList.remove("selected");
            }
          }
        } catch (e) {
          console.warn(e);
        }
        save_settings();
      }
      const color_list = [
        "seashell",
        "rgb(247, 239, 208)",
        "rgb(249, 230, 230)",
        "#DAB1D5",
        "#ACD6FF",
        "rgb(205, 223, 205)",
        "#647466",
        "white",
        "#f9f9f9",
        "rgb(237,237,237)",
        "#D0D0D0",
        "#555555",
        "#1b1b1b",
        "black",
      ];
      function create_color_selector(elem) {
        const target = elem.getAttribute("target");
        elem.innerHTML = color_list
          .map((color) =>
            `<button class="color-ball" style="background-color:${color}" onclick="set_color('${target}', '${color}')"></button>`
          )
          .join("");
      }
      for (
        const elem of document.getElementsByClassName("color-selector")
      ) {
        create_color_selector(elem);
      }
      load_settings();

      function get_name(name) {
        return name.replace(/[\/\\\.\?\*\"\<\>\|]/g, "_");
      }
      async function get_opfs_list() {
        try {
          const root = await navigator.storage.getDirectory();
          const folder = await root.getDirectoryHandle(
            "txt_reader_data",
            { create: false },
          );
          const entries = await folder.values();
          const list = [];
          for await (const entry of entries) {
            list.push(entry.name);
          }
          console.log("✅ OPFS 文件列表:", list);
          return list;
        } catch (error) {
          console.error("❌ 获取文件列表失败:", error);
        }
      }
      async function save_to_opfs(name, data) {
        const jsonString = JSON.stringify(data);
        const file_name = get_name(name) + ".json";
        try {
          // 获取 OPFS 根目录
          const root = await navigator.storage.getDirectory();
          const folder = await root.getDirectoryHandle(
            "txt_reader_data",
            { create: true },
          );
          // 创建或打开文件
          const fileHandle = await folder.getFileHandle(file_name, {
            create: true,
          });
          // 获取可写流并写入数据
          const writable = await fileHandle.createWritable();
          await writable.write(jsonString);
          await writable.close();
          console.log("✅ JSON 数据已保存到 OPFS");
        } catch (error) {
          console.error("❌ 写入失败:", error);
        }
      }
      async function load_from_opfs(name) {
        const file_name = name;
        // const file_name = name.replace(/[\/\\\.\?\*\"\<\>\|\n\r]/g, "_") + '.json';
        try {
          const root = await navigator.storage.getDirectory();
          const folder = await root.getDirectoryHandle(
            "txt_reader_data",
            { create: true },
          );
          const fileHandle = await folder.getFileHandle(file_name, {
            create: false,
          });
          const file = await fileHandle.getFile();
          // 读取文件内容并解析 JSON
          const text = await file.text();
          const data = JSON.parse(text);
          console.log("✅ 读取到的 JSON 数据:", data);
          return data;
        } catch (error) {
          console.error("❌ 读取失败:", error);
          return null;
        }
      }
      async function remove_in_opfs(name) {
        const file_name = name;
        // const file_name = name.replace(/[\/\\\.\?\*\"\<\>\|\n\r]/g, "_") + '.json';
        try {
          const root = await navigator.storage.getDirectory();
          const folder = await root.getDirectoryHandle(
            "txt_reader_data",
            { create: true },
          );
          const fileHandle = await folder.getFileHandle(file_name, {
            create: false,
          });
          await fileHandle.remove();
          console.log("✅ 文件已删除");
        } catch (error) {
          console.error("❌ 删除失败:", error);
        }
      }
      // saveJsonToOPFS();
      // readJsonFromOPFS();
      // get_opfs_list();
      async function load_from(name) {
        const data = await load_from_opfs(name);
        if (!data) {
          return;
        }
        try {
          set_format_as_opened();
          // const name = data.file_name;
          state.file_name = data.file_name;
          state.titles = data.titles;
          state.contents = data.contents;
          state.reading_time = null;
          state.last_time = null;
          state.chapter = null;
          updateStorage();
          readChapter(null);
        } catch (e) {
          console.error(e);
          await remove_in_opfs(name);
        }
      }

      loadFromOpfs.addEventListener("click", async () => {
        const list = await get_opfs_list();
        if ((!list) || list.length === 0) {
          return;
        }
        selectList.style.display = "flex";
        fileList.innerHTML = list.map((name) =>
          `<li onclick="load_from('${name}')">${
            name.endsWith(".json") ? name.slice(0, -5) : name
          }</li>`
        ).join("");
      });
      selectList.addEventListener("click", (event) => {
        selectList.style.display = "none";
      });

      setTimeout(() => {
        document.getElementById("javascript-disabled").style.display =
          "none";
        const file_name = JSON.parse(
          localStorage.getItem("txt_reader_cache"),
        )?.reading;
        if (file_name) {
          const name = get_name(file_name) + ".json";
          load_from(name);
        }
      }, 500);

      // 打开数据库
      async function openDatabase(STORE_NAME) {
        const DB_NAME = "TxtReaderDatabase";
        const DB_VERSION = 2;

        if (state.db) {
          if (state.db.objectStoreNames.contains(STORE_NAME)) {
            return state.db;
          }
        }

        const db = await new Promise((resolve) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              db.createObjectStore(STORE_NAME);
            }
          };
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
        state.db = db;
        return db;
      }
      // 存储数据，按 `name` 和 `key`
      async function saveDatabase(name, key, data) {
        const STORE_NAME = get_name(name);
        const db = await openDatabase(STORE_NAME);
        const transaction = db.transaction(STORE_NAME, "readwrite");
        const store = transaction.objectStore(STORE_NAME);
        store.put(data, key);

        return new Promise((resolve, reject) => {
          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        });
      }

      // 按 `name` 和 `key` 读取数据
      async function getDatabase(name, key) {
        try {
          const STORE_NAME = get_name(name);
          const db = await openDatabase(STORE_NAME);
          const transaction = db.transaction(STORE_NAME, "readonly");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.get(key);

          return new Promise((resolve, reject) => {
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        } catch (e) {
          console.warn(e);
          return null;
        }
      }

      document.addEventListener("mouseup", function (event) {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();
        if (selectedText.length > 0) {
          showContextMenu(event.pageX, event.pageY);
        } else {
          hideContextMenu();
        }
      }, true);

      function showContextMenu(x, y) {
        const menu = document.getElementById("contextMenu");
        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
        menu.style.display = "block";
        console.log(x, y);
      }

      function hideContextMenu() {
        document.getElementById("contextMenu").style.display = "none";
      }
      function getNodeInfo(anchorNode, anchorOffset) {
        // 查找最近的 <p> 父级元素
        let parentP = anchorNode;
        while (parentP && parentP.nodeName !== "P") {
          parentP = parentP.parentNode;
        }
        if (!parentP) return null; // 选区不在 <p> 内

        // 计算 offset
        let offset = 0;
        let found = false;

        function traverse(node) {
          if (found) return;
          if (node === anchorNode) {
            offset += anchorOffset;
            found = true;
            return;
          }
          if (node.nodeType === Node.TEXT_NODE) {
            offset += node.textContent.length;
          } else if (node.nodeType === Node.ELEMENT_NODE) {
            for (let child of node.childNodes) {
              traverse(child);
            }
          }
        }

        for (let child of parentP.childNodes) {
          traverse(child);
          if (found) break;
        }

        return { parentP, offset };
      }
      function get_selected_range() {
        const selection = window.getSelection();
        if (selection.rangeCount === 0) {
          console.log("未选中文本");
          return null;
        }

        const range = selection.getRangeAt(0);
        const startNode = range.startContainer;
        const endNode = range.endContainer;

        const { parentP: startP, offset: startOffset } = getNodeInfo(
          startNode,
          range.startOffset,
        );
        const { parentP: endP, offset: endOffset } = getNodeInfo(
          endNode,
          range.endOffset,
        );

        // const contentDiv = document.getElementById("content");
        const paragraphs = Array.from(
          fileContent.getElementsByTagName("p"),
        );

        let startLine = paragraphs.indexOf(startP);
        let endLine = paragraphs.indexOf(endP);

        if (startLine === -1 || endLine === -1) {
          console.log("选区不在 content 内");
          return null; // 选区不在 content 内
        }

        return [[startLine, startOffset], [
          endLine - startLine,
          startLine === endLine ? endOffset - startOffset : endOffset,
          selection.toString(),
        ]];
      }

      async function set_highlight(type = "highlight") {
        const [start, extend, text] = get_selected_range();
        const notes = type === "highlight"
          ? null
          : prompt("请输入注释：");
        console.log(type, start, extend, notes);
        state.highlights.push({
          pos: start,
          extends: extend,
          type,
          time: Date.now(),
          notes,
          text,
        });
        await saveDatabase(
          state.file_name,
          state.chapter,
          state.highlights,
        );
        const top = document.documentElement.scrollTop;
        const left = document.documentElement.scrollLeft;
        await readChapter(state.chapter);
        hideContextMenu();
        window.scrollTo(left, top);
      }

      // 标记（高亮）
      document.getElementById("highlightText").addEventListener(
        "click",
        () => set_highlight("highlight"),
      );
      // 注释
      document.getElementById("commentText").addEventListener(
        "click",
        () => set_highlight("notes"),
      );

      // 复制
      document.getElementById("copyText").addEventListener(
        "click",
        function () {
          const selection = window.getSelection().toString();
          navigator.clipboard.writeText(selection).then(() => {
            hideContextMenu();
          }).catch((err) => {
            console.warn("复制失败：" + err);
          });
        },
      );

      saveDbToFile.addEventListener("click", async () => {
        const STORE_NAME = get_name(state.file_name);
        const db = await openDatabase(STORE_NAME);

        const transaction = db.transaction(STORE_NAME, "readonly");
        const store = transaction.objectStore(STORE_NAME);
        const allData = [];

        store.openCursor().onsuccess = (event) => {
          const cursor = event.target.result;
          if (cursor) {
            // console.log(cursor)
            allData.push([cursor.key, cursor.value]);
            cursor.continue();
          } else {
            // 转换为 JSON 并触发下载
            const jsonStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonStr], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = `${STORE_NAME}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            resolve("Export successful");
          }
        };
      });
      loadDbFromFile.addEventListener(
        "click",
        () => fileInput2.click(),
      );
      fileInput2.addEventListener("change", async (event) => {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = async () => {
          const data = JSON.parse(reader.result);
          const STORE_NAME = get_name(state.file_name);
          const db = await openDatabase(STORE_NAME);
          const transaction = db.transaction(STORE_NAME, "readwrite");
          const store = transaction.objectStore(STORE_NAME);
          data.forEach(([key, value]) => store.put(value, key));
          console.log("✅ 数据库已导入");
        };
        reader.onerror = (e) => {
          console.error(e);
        };
        reader.readAsText(file);
      });
    </script>
  </body>
</html>
